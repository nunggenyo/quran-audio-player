<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pemain Audio Surah Quran - Pelbagai Qari</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #eef6ff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #credit {
      position: fixed;
      bottom: 10px;
      right: 15px;
      font-size: 13px;
      color: #64748b;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(5px);
      z-index: 100;
    }

    #ayatImg {
      max-width: 100%;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <main class="card shadow-lg p-4" style="width: min(95%, 600px);">
    <h4 class="mb-3 text-center">ðŸŽ§ Pemain Audio Surah Quran</h4>

    <div class="row mb-2 align-items-center">
      <div class="col-auto">
        <label for="qari" class="form-label mb-0" style="width:50px;">Qari</label>
      </div>
      <div class="col">
        <select id="qari" class="form-select w-auto">
          <option>Abdul Basit</option>
          <option>Alafasy</option>
        </select>
      </div>
    </div>

    <div class="row mb-2 align-items-center">
      <div class="col-auto">
        <label for="surah" class="form-label mb-0" style="width:50px;">Surah</label>
      </div>
      <div class="col">
        <select id="surah" class="form-select w-auto"></select>
      </div>
    </div>

    <div class="row mb-2 align-items-center">
      <div class="col-auto">
        <label for="ayat" class="form-label mb-0" style="width:50px;">Ayat</label>
      </div>
      <div class="col">
        <input id="ayat" type="number" min="1" value="1" class="form-control" style="max-width:100px;"/>
      </div>
    </div>


    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <div class="btn-group">
        <button id="loadBtn" class="btn btn-primary">â–¶ Play</button>
        <!-- <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu">
          <li><button id="playSurahBtn" class="dropdown-item">Play Surah</button></li>
        </ul> -->
      </div>
      <button id="pauseBtn" class="btn btn-secondary" disabled>Pause</button>
      <button id="stopBtn" class="btn btn-secondary" disabled>Stop</button>
      <button id="nextBtn" class="btn btn-secondary" disabled>Next</button>
      <div class="form-check ms-1">
        <input class="form-check-input" type="checkbox" id="loopChk">
        <label class="form-check-label" for="loopChk">Repeat</label>
      </div>
    </div>

    <!-- <div class="mb-3">
      <label for="vol" class="form-label">Volum</label>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="1" class="form-range w-auto">
    </div> -->
    
    <div style="overflow:auto; max-width:100%; max-height:500px; text-align:right;">
      <img id="ayatImg" src="" style="width:auto; height:auto;"
      onerror="this.onerror=null;this.src='';document.getElementById('imgStatus').textContent='Imej tidak dijumpai';">
    </div>

    <div class="small text-muted" id="imgStatus"></div>

    <div class="mt-3 mb-1">
      <div class="progress" style="height: 8px;">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
      </div>
    </div>

    <div class="small text-muted mt-2">
      Sedang main: <span id="current"></span><br>
      Status: <span id="status">Sedia</span><br>
      Waktu: <span id="time">00:00 / 00:00</span>
    </div>

    <div id="credit">
      <span>Quran Audio Player by Hafizul Amri</span><br/>
      <span>Sumber audio dan imej dari everyayah.com</span>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ======== Data Qari dan Surah (sama seperti versi asal) ========
    // const qariData = {
    //   "1": { "subfolder": "Abdul_Basit_Mujawwad_128kbps", "name": "Abdul Basit Mujawwad" },
    //   "2": { "subfolder": "Abdul_Basit_Murattal_192kbps", "name": "Abdul Basit Murattal" },
    //   "14": { "subfolder": "Alafasy_128kbps", "name": "Alafasy" },
    //   "29": { "subfolder": "khalefa_al_tunaiji_64kbps", "name": "Khalefa Al-Tunaiji" },
    //   "46": { "subfolder": "Yaser_Salamah_128kbps", "name": "Yaser Salamah" }
    // };
    let qariData = {};  // declare const/let kosong dulu

    fetch('qariData.json')
      .then(response => response.json())
      .then(data => {
        qariData = data;       // assign data dari JSON ke qariData
        console.log(qariData); // boleh guna macam const asal
        // Contoh: isi select Qari
        const qariSelect = document.getElementById('qari');
        Object.entries(qariData).forEach(([id, q]) => {
          const opt = document.createElement('option');
          opt.value = q.subfolder;
          opt.textContent = q.name;
          // if (id === "46") opt.selected = true;
          qariSelect.appendChild(opt);
        });
      })
      .catch(err => console.error('Gagal load qariData:', err));

    // const surahList = [
    //   "1 - Al-Fatihah", "2 - Al-Baqarah", "3 - Ali Imran", "4 - An-Nisa", "5 - Al-Maidah",
    //   "36 - Ya-Sin", "55 - Ar-Rahman", "56 - Al-Waqiah", "67 - Al-Mulk", "112 - Al-Ikhlas"
    // ];

    fetch('surahData.json')
      .then(res => res.json())
      .then(surahList => {
        // surahList adalah array
        surahList.forEach(surahName => {
          const opt = document.createElement('option');
          opt.textContent = surahName;
          opt.value = surahName; // optional, kalau nak value sama
          surahSelect.appendChild(opt);
        });
      })
      .catch(err => console.error("Gagal load surahList:", err));



    const imgBase = 'https://everyayah.com/data/images_png/';
    const qariSelect = document.getElementById('qari');
    const surahSelect = document.getElementById('surah');
    const ayatInput = document.getElementById('ayat');
    const loadBtn = document.getElementById('loadBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const nextBtn = document.getElementById('nextBtn');
    const loopChk = document.getElementById('loopChk');
    // const vol = document.getElementById('vol');
    const progressBar = document.getElementById('progressBar');
    const status = document.getElementById('status');
    const time = document.getElementById('time');
    const current = document.getElementById('current');
    const ayatImg = document.getElementById('ayatImg');
    const imgStatus = document.getElementById('imgStatus');

    let baseUrl = '';
    let audio = new Audio();
    let cacheBlob = null;

    // // Isi senarai Qari
    // Object.entries(qariData).forEach(([id, q]) => {
    //   const opt = document.createElement('option');
    //   opt.value = q.subfolder;
    //   opt.textContent = q.name;
    //   if (id === "46") opt.selected = true;
    //   qariSelect.appendChild(opt);
    // });

    // Isi senarai Surah
    // surahList.forEach(name => {
    //   const opt = document.createElement('option');
    //   opt.textContent = name;
    //   surahSelect.appendChild(opt);
    // });

    function pad(num, len) { return num.toString().padStart(len, '0'); }
    function fmt(t) { if (!isFinite(t)) return '00:00'; const m = Math.floor(t / 60).toString().padStart(2, '0'); const s = Math.floor(t % 60).toString().padStart(2, '0'); return `${m}:${s}`; }
    function updateImage(surahNum, ayatNum) {
      const imgUrl = `${imgBase}${surahNum}_${ayatNum}.png`;
      ayatImg.src = imgUrl;
      imgStatus.textContent = '';
    }
    function updateBaseUrl() {
      const qariFolder = qariSelect.value;
      baseUrl = `https://everyayah.com/data/${qariFolder}/`;
    }

    async function playAyat() {
      updateBaseUrl();
      const surahNum = parseInt(surahSelect.value.split(' - ')[0]);
      const ayatNum = parseInt(ayatInput.value) || 1;
      const surahStr = pad(surahNum, 3);
      const ayatStr = pad(ayatNum, 3);
      const file = `${surahStr}${ayatStr}.mp3`;
      const url = baseUrl + file;
      current.textContent = `${surahSelect.value} : Ayat ${ayatNum}`;
      status.textContent = 'Memuat audio...';
      updateImage(surahNum, ayatNum);
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("404");
        const blob = await res.blob();
        cacheBlob = URL.createObjectURL(blob);
        audio.src = cacheBlob;
        audio.loop = loopChk.checked;
        // audio.volume = parseFloat(vol.value);
        await audio.play();
        status.textContent = 'Main';
        pauseBtn.disabled = false;
        stopBtn.disabled = false;
        nextBtn.disabled = false;
      } catch (e) {
        status.textContent = 'Gagal memuat audio';
      }
    }

    async function playFullSurah() {
      const surahNum = parseInt(surahSelect.value.split(' - ')[0]);
      let ayatNum = 1, teruskan = true;
      while (teruskan) {
        ayatInput.value = ayatNum;
        await playAyat();
        await new Promise(resolve => {
          audio.onended = () => resolve();
          audio.onerror = () => resolve();
        });
        ayatNum++;
        const nextUrl = `${baseUrl}${pad(surahNum, 3)}${pad(ayatNum, 3)}.mp3`;
        const res = await fetch(nextUrl);
        if (!res.ok) teruskan = false;
      }
      status.textContent = 'Selesai main satu surah.';
    }

    qariSelect.onchange = () => stopBtn.onclick();
    surahSelect.onchange = () => { ayatInput.value = 1; updateImage(parseInt(surahSelect.value.split(' - ')[0]), 1); };
    loadBtn.onclick = playAyat;
    pauseBtn.onclick = () => { audio.pause(); status.textContent = 'Pause'; };
    stopBtn.onclick = () => { audio.pause(); audio.currentTime = 0; status.textContent = 'Berhenti'; };
    nextBtn.onclick = () => { audio.pause(); ayatInput.value = parseInt(ayatInput.value || 1) + 1; playAyat(); };
    // vol.oninput = () => audio.volume = parseFloat(vol.value);
    loopChk.onchange = () => audio.loop = loopChk.checked;

    audio.ontimeupdate = () => {
      if (audio.duration) {
        progressBar.style.width = (audio.currentTime / audio.duration * 100) + '%';
      }
      time.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`;
    };

    document.getElementById('playSurahBtn').onclick = async () => {
      status.textContent = 'Main satu surah penuh...';
      await playFullSurah();
    };

    updateBaseUrl();
  </script>
</body>
</html>
